{% extends "staff/header.html" %}
{% block content %}
<div class="container-fluid">
    <div id="viewCourses">
        <h3 style='text-align:center'>My Courses</h3>
        <div id="courseList"></div>
        <hr>
        <h3 style='text-align:center'>Add a Course</h3>
        <form id="addCourseForm">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theCoursecode">Course Code</label>
                    <input class="form-control" type="text" id="theCoursecode" name="courseCode" placeholder="Please enter Course Code">
                </div>
                <div class="form-group">
                <label for="theCategory">Category</label>
                    <select class="form-control" name='category' id="theCategory"><option value='' selected>All Categories</option></select>
                </div>
                <div class="form-group">
                    <label for="theTitle">Title</label>
                    <input class="form-control" name='title' placeholder="Enter Course Title" id="theTitle">
                </div>
                <div class="form-group">
                    <label for="theDesc">Description</label>
                    <textarea class="form-control" rows='4' type="text" name="description" id="theDesc"></textarea>
                </div>
                <input type="button" value='Add Course' class="btn btn-default" onclick="addCourse()">
            </div>
        </form>
        <hr>
        <h3 style='text-align:center'>Update Course Information</h3>
        <form id="updateCourseForm">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theOldCourseCode">Old Course Code</label>
                    <input class="form-control" type="text" name="oldCourseCode" placeholder="Enter the old Course Code" id="theOldCourseCode">
                </div>
                <div class="form-group">
                    <label for="theCoursecode">Course Code</label>
                    <input class="form-control" type="text" id="theCoursecode" name="courseCode" placeholder="Please enter Course Code">
                </div>
                <div class="form-group">
                    <label for="theCategory">Category</label>
                    <select class="form-control" name='category' id="theCategory"><option value='' selected>All Categories</option></select>
                </div>
                <div class="form-group">
                    <label for="theDesc">Description</label>
                    <textarea class="form-control" rows='4' type="text" name="description" id="theDesc"></textarea>
                </div>
                <input type="button" value='Update Course' class="btn btn-default" onclick="updateCourse()">
            </div>

        </form>
    </div>

    <div id="viewModules">
        <h3 style="text-align: center"><a class='backToCourse' href='#'>Courses</a> | Modules</h3>
        <ul class='sortable' id="moduleList"></ul>

        <hr>

        <h3 style="text-align: center">Add Module</h3>
        <form id="addModuleForm">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theModuleTitle">Module Title:</label>
                    <input type="text" class="form-control" name="moduleTitle" placeholder="Enter Module Title" id="theModuleTitle">
                </div>
                <div class="form-group">
                    <label for="theSeqNum">Sequence Number:</label>
                    <input type="text" class="form-control" name="sequenceNumber" placeholder="Enter Module Sequence Number">
                </div>
                    <input type="button" class="btn btn-default" value='Add Module' onclick="addModule()">
            </div>
        </form>

        <hr>

        <h3 style="text-align: center">Update Module</h3>
        <form id="updateModule">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theModuleNum">Module Number:</label>
                    <input type="text" class="form-control" name="moduleNumber" placeholder="Enter Module Number" id="theModuleNum">
                </div>
                <div class="form-group">
                    <label for="theModuleTitle">Module Title:</label>
                    <input type="text" class="form-control" name="moduleTitle" placeholder="Enter Module Title" id="theModuleTitle">
                </div>
                    <input type="button" class="btn btn-default" value='Update Module' onclick="updateModule()">
            </div>
            <!--Module Number: <input type="text" name="moduleNumber" placeholder="Module Number"> <br>
            Module Title: <input type="text" name="moduleTitle" placeholder="Module Title"> <br>
            <input type="button" value='Update Module' onclick="updateModule()">-->
        </form>

        <hr>

        <h3 style="text-align: center">Remove Module</h3>
        <form id="removeModule">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theModuleNum">Module Number:</label>
                    <input type="text" class="form-control" name="moduleNumber" placeholder="Enter Module Number" id="theModuleNum">
                </div>
                    <input type="button" class="btn btn-danger" value='Remove Module' onclick="removeModule()">
            </div>
            <!--Module Number: <input type="text" name="moduleNumber" placeholder="Module Number"> <br>
            <input type="button" value='Remove Module' onclick="removeModule()">-->
        </form>

    </div>
    <div id="viewComponents">
        <h3 style="text-align:center"><a class='backToCourse' href='#'>Courses</a> | <a class='backToModule' href='#'>Modules</a> | Components</h3>
        <ul class='sortable' id="componentList"></ul>
        <hr>
        <h3 style="text-align:center">Content</h3>
        <div id='componentContent'></div>
        <hr>
        <h3 style="text-align:center">Add Component</h3>
        <form id="addComponentForm">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="theOrder">Order:</label>
                    <input type="text" class="form-control" name="order" placeholder="Enter Component Order" id="theOrder">
                </div>
                <div class="form-group">
                    <label for="theContentType">Content Type:</label>
                    <input type="text" class="form-control" name="contentType" placeholder="Enter Content Type" id="theContentType">
                </div>
                <div class="form-group">
                    <label for="theContentTitle">Content Title:</label>
                    <input type="text" class="form-control" name="contentTitle" placeholder="Enter Content Title" id="theContentTitle">
                </div>
                <div class="form-group">
                    <label for="theContent">Content:</label>
                    <textarea class="form-control" rows='4' type="text" name="content" id="theContent"></textarea>
                </div>
                    <input type="button" class="btn btn-default" value='Add Component' onclick="addComponent()">
            </div>
            <!--Order: <input type="text" name="order" placeholder="Component Order"> <br>
            Content Type: <input type="text" name="contentType" placeholder="Content Type"> <br>
            Content Title: <input type="text" name="contentTitle" placeholder="Content Title"> <br>
            Content: <textarea rows='4' cols='50' type="text" name="content" placeholder="Content"></textarea><br>
            <input type="button" value='Add Component' onclick="addComponent()">-->
            <!--<input id='uploadedfile' type="file" placeholder="Upload file">
            <button onclick="uploadFunc()"> Upload </button>
            <button onclick="deleteFunc()"> Delete </button>
            <a id="link" href="#"> The uploaded file </a>-->
        </form>
    </div>

</div>

<!--
<div id="viewModules">
    <h3><a class='backToCourse' href='#'>Courses</a> / Modules</h3>
    <ul class='sortable'></ul>

    <hr>

    <h3>Add Module</h3>
    <form id="addModuleForm">
        Module Title: <input type="text" name="moduleTitle" placeholder="Module Title"> <br>
        Sequence Number: <input type="text" name="sequenceNumber" placeholder="Module Sequence Number"> <br>
        <input type="button" value='Add Module' onclick="addModule()">
    </form>

    <hr>

    <h3>Update Module</h3>
    <form id="updateModule">
        Module Number: <input type="text" name="moduleNumber" placeholder="Module Number"> <br>
        Module Title: <input type="text" name="moduleTitle" placeholder="Module Title"> <br>
        <input type="button" value='Update Module' onclick="updateModule()">
    </form>

    <hr>

    <h3>Remove Module</h3>
    <form id="removeModule">
        Module Number: <input type="text" name="moduleNumber" placeholder="Module Number"> <br>
        <input type="button" value='Remove Module' onclick="removeModule()">
    </form>

</div>-->
<!--
<div id="viewComponents">
    <h3><a class='backToCourse' href='#'>Courses</a> / <a class='backToModule' href='#'>Modules</a> | Components</h3>
    <ul class='sortable'></ul>
    <hr>
    <h3>Content</h3>
    <div id='componentContent'></div>
    <hr>
    <h3>Add Component</h3>
    <form id="addComponentForm">
        Order: <input type="text" name="order" placeholder="Component Order"> <br>
        Content Type: <input type="text" name="contentType" placeholder="Content Type"> <br>
        Content Title: <input type="text" name="contentTitle" placeholder="Content Title"> <br>
        Content: <textarea rows='4' cols='50' type="text" name="content" placeholder="Content"></textarea><br>
        <input type="button" value='Add Component' onclick="addComponent()">
        comment here <input id='uploadedfile' type="file" placeholder="Upload file">
        <button onclick="uploadFunc()"> Upload </button>
        <button onclick="deleteFunc()"> Delete </button>
        <a id="link" href="#"> The uploaded file </a> end here
    </form>
</div>-->

<script type="text/javascript">

    //*********************************
    // INITIAL STATE
    //*********************************

    var thisCourse;
    var thisModule;
    $('#viewModules').hide();
    $('#viewComponents').hide();
    $('#viewCourses').show();
    loadCourses();

    //load categories for course creation form
    $.ajax({
        url: 'http://localhost:8000/courses/categories',
        type: 'GET',
        dataType: 'json',
        success(result,status,xhr) {    
            $.each(result.all_categories, function(index, value) {
                $('select[name=category]').append("<option value='" + value.name + "'>" + value.name + "</option>");          
            });
        }
    });


    //*********************************
    // PAGE CONTROL LOGIC
    //*********************************

    $('a.backToCourse').click(function() {
        $('#viewModules').hide();
        $('#viewComponents').hide();
        $('#viewCourses').show();
    });

    $('a.backToModule').click(function() {
        $('#viewComponents').hide();
        $('#viewCourses').hide();
        $('#viewModules').show();
    });

    $("#viewCourses").on('click','a',function(){
        $('#viewComponents').hide();
        $('#viewCourses').hide();      
        thisCourse = $(this).attr('rel');
        loadModules();
        $('#viewModules').show();
    });

    $('#viewModules').on('click','li a',function() {
        $('#viewModules').hide();
        $('#viewCourses').hide();
        thisModule = $(this).attr('rel');
        loadComponents();
        $('#viewComponents').show();
    })


    //*********************************
    // VIEW COURSES
    //*********************************

    //load all courses created by this instructor
    function loadCourses() {
        $.ajax({
            url: 'http://localhost:8000/staff/' + getCookie('staffId') + '/courselist_instructor',
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {      
                $("#courseList").empty();
                console.log(JSON.stringify(result))        
                $.each(result.course_list, function(index, value) {
                    $("#courseList").append("<p><a href='#' rel='" + value.courseCode + "'>" + value.courseCode + ": " + value.title + "</a><br>Category: " + value.category + "<br>Description: " + value.description + '</p>');
                    if(!value.isPublished) {
                        $("#courseList").append("<button class='publish btn btn-primary' rel='" + value.courseCode + "' type='button'>Publish</button>");
                        $("#courseList").append("<button class='remove btn btn-danger' rel='" + value.courseCode + "' type='button' style='margin-left:5px'>Remove</button>");
                    }
                });
            }
        });
    }

    //add a course
    function addCourse() {
        var form = document.getElementById('addCourseForm');
        console.log(form.courseCode.value);
        console.log(form.category.value);
        console.log(form.title.value);
        console.log(form.description.value);

        $.ajax({
            url: 'http://localhost:8000/courses/addCourse',
            type: 'POST',
            data: JSON.stringify({
                instructor: getCookie('staffId'),
                courseCode: form.courseCode.value,
                category: form.category.value,
                isPublished: false,
                title: form.title.value,
                description: form.description.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadCourses();
                    form.courseCode.value = "";
                    form.category.value = "";
                    form.title.value = "";
                    form.description.value = "";
                }
            }
        });
    }

    //update course
    function updateCourse() {
        var form = document.getElementById('updateCourseForm');
        $.ajax({
            url: 'http://localhost:8000/courses/' + form.oldCourseCode.value + '/update_course_contents',
            type: 'POST',
            data: JSON.stringify({
                new_courseCode: form.courseCode.value,
                new_category: form.category.value,
                new_title: form.title.value,
                new_description: form.description.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadCourses();
                    form.oldCourseCode.value = "";
                    form.courseCode.value = "";
                    form.category.value = "";
                    form.title.value = "";
                    form.description.value = "";
                }
            }
        });
    }

    //publish a course
    $('#courseList').on('click', 'button.publish', function() {
        cf = confirm("Please confirm that you want to publish this course");
        if (cf) {
            $.ajax({
                url: 'http://localhost:8000/courses/' + $(this).attr('rel') + '/publish',
                type: 'POST',
                dataType: 'json',
                beforeSend(xhr) {
                    xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                },
                success(result,status,xhr) {
                    if (result.hasOwnProperty('failure'))
                        alert(result.message);
                    else {
                        loadCourses();
                    }
                }
            });
        }
    });

    //remove a course
    $('#courseList').on('click', 'button.remove', function() {
        cf = confirm("Please confirm that you want to remove this course");
        if (cf) {
            $.ajax({
                url: 'http://localhost:8000/courses/' + $(this).attr('rel') + '/remove',
                type: 'POST',
                dataType: 'json',
                beforeSend(xhr) {
                    xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                },
                success(result,status,xhr) {
                    if (result.hasOwnProperty('failure'))
                        alert(result.message);
                    else {
                        loadCourses();
                    }
                }
            });
        }
    });

    //*********************************
    // MODULES
    //*********************************

    //display modules and components
    function loadModules() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $("#moduleList").empty();
                $.each(result.modules, function(index, value) {
                    $('#moduleList').append("<li class='ui-state-default' id='"+value.id+"'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><a href='#' rel='" + value.sequenceNumber + "''><b>Module " + value.sequenceNumber + " : " + value.moduleTitle + "</b> - " + value.component_count + " components</a><div id='" + value.id + "'></div></li>");
                });
            }
        });
    }

    // Update db after finishing reordering module
    $(function() {
        $('#moduleList').sortable({
            update: function(event, ui) {
                var IDs = $("#moduleList li[id]").map(function() { return this.id; }).get();
                $.each(IDs, function(index, value) {
                    IDs[index] = {"id":IDs[index],"sequenceNumber":+index};
                });
                console.log(IDs);
                $.ajax({
                    url: 'http://localhost:8000/courses/' + thisCourse + '/update_module_order',
                    type: 'POST',
                    data: JSON.stringify({"module_sequences": IDs}),
                    dataType: 'json',
                    beforeSend(xhr) {
                        xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                    },
                    success(result,status,xhr) {
                        if (result.hasOwnProperty('failure')){
                            alert(result.message);  
                        }
                        loadModules();
                    }
                });
                
            }
        });
    });


    //add modules
    function addModule() {
        var form = document.getElementById('addModuleForm');
        $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse + "/addModule",
            type: 'POST',
            data: JSON.stringify({
                moduleTitle: form.moduleTitle.value,
                sequenceNumber: form.sequenceNumber.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadModules();
                }   
            }
        });
    }

    //update modules
    function updateModule() {
        var form = document.getElementById('updateModule');
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse + '/modules/' + form.moduleNumber.value + '/update_content',
            type: 'POST',
            data: JSON.stringify({moduleTitle: form.moduleTitle.value}),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadModules();
                }
            }
        });
    }

    //remove module
    function removeModule() {
        var form = document.getElementById('removeModule');
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse + '/modules/' + form.moduleNumber.value + '/remove_module',
            type: 'POST',
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadModules();
                }
            }
        });
    }

    //*********************************
    // COMPONENTS
    //*********************************

    function loadComponents() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $('#componentList').empty();
                $('#componentContent').empty();
                $.each(result.modules, function(index, value) {
                    if (value.sequenceNumber == thisModule)
                    $.each(value.components, function(index, data) {
                        $('#componentList').append("<li class='ui-state-default' id='"+data.contentType+"|"+data.id+"'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><a href='#' rel='" + data.id + "'><b>Component " + data.order + " : " + data.contentTitle + "</b></a><div id='" + data.id + "'></div></li>");
                    });
                });
            }
        });
    }

    // Update db after finishing reordering comonents
    $(function() {
        $('#componentList').sortable({
            update: function(event, ui) {
                var cData = $("#componentList li[id]").map(function() { return this.id; }).get();
                $.each(cData, function(index, value) {
                    var input = cData[index].split("|");
                    cData[index] = {"contentType":input[0],"component_id":input[1], "order":index};
                });

                var data = JSON.stringify({"component_sequences": cData})
                console.log(data);

                $.ajax({
                    url: 'http://localhost:8000/courses/' + thisCourse + '/modules/' + thisModule + '/update_component_order',
                    type: 'POST',
                    data: JSON.stringify({"component_sequences": cData}),
                    dataType: 'json',
                    beforeSend(xhr) {
                        xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                    },
                    success(result,status,xhr) {
                        if (result.hasOwnProperty('failure')){
                            alert(result.message);  
                        }
                        loadComponents();
                    }
                });
                
            }
        });
    });

    //display component content
    $('#viewComponents').on('click','li a', function() {
        var thisComponent = $(this).attr('rel');
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $('#componentContent').empty();
                $.each(result.modules, function(index, value) {
                    if (value.sequenceNumber == thisModule)
                    $.each(value.components, function(index, data) {
                        if (data.id == thisComponent)
                            $('#componentContent').append("<p>" + data.content + "</p><button rel='" + data.id + "' type='button' class='btn btn-danger'>Remove This Component</button>");
                    });
                });
            }
        });
    });

    //remove a component
    $('#componentContent').on('click','button', function() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse + '/modules/' + thisModule + '/components/' + $(this).attr('rel') + '/remove',
            type: 'POST',
            data: JSON.stringify({contentType : 'text'}),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadComponents();
                }
            }

        });
    });

    function addComponent() { 
        form = document.getElementById('addComponentForm');
        $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse + "/modules/" + thisModule + "/addComponent",
            type: 'POST',
            data: JSON.stringify({
                order: form.order.value,
                contentType: form.contentType.value,
                content: form.content.value,
                contentTitle: form.contentTitle.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadComponents();
                }                
            }
        });
    }
</script>

{% endblock %}