{% extends "staff/header.html" %}
{% block content %}

<div id="viewCourses">
    <h3>View Courses</h3>
    <div id="courseList"></div>
    <hr>
    <h3>Add a Course</h3>
    <form id="addCourseForm">
        Course Code <input type="text" name="courseCode" placeholder="Course Code"> <br>
        Category <select name='category'><option value='' selected>All Categories</option></select><br>
        Title <input type="text" name="title" placeholder="Course Title"> <br>
        Description <textarea rows='4' cols='50' type="text" name="description">Course Description</textarea><br>
        <input type="button" value='Add Course' onclick="addCourse()">
    </form>
    <hr>
    <h3>Update Course Information</h3>
    <form id="updateCourseForm">
        Old Course Code <input type="text" name="oldCourseCode" placeholder="Old Course Code"> <br>
        Course Code <input type="text" name="courseCode" placeholder="Course Code"> <br>
        Category <select name='category'><option value='' selected>All Categories</option></select><br>
        Title <input type="text" name="title" placeholder="Course Title"> <br>
        Description <textarea rows='4' cols='50' type="text" name="description">Course Description</textarea><br>
        <input type="button" value='Update Course' onclick="updateCourse()">
    </form>
</div>

<div id="viewModCom">
    <h3><a href='#'>View Courses</a> / Modules and Components</h3>
    <ul id='sortable'></ul>

    <hr>

    <h3>Add Module</h3>
    <form id="addModuleForm">
        Module Title: <input type="text" name="moduleTitle" placeholder="Module Title"> <br>
        Sequence Number: <input type="text" name="sequenceNumber" placeholder="Module Sequence Number"> <br>
        <input type="button" value='Add Module' onclick="addModule()">
    </form>

    <hr>

    <h3>Add Component</h3>
    <form id="addComponentForm">
        Module Number: <input type="text" name="moduleSeq" placeholder="Module Number"> <br>
        Order: <input type="text" name="order" placeholder="Component Order"> <br>
        Content Type: <input type="text" name="contentType" placeholder="Content Type"> <br>
        Content Title: <input type="text" name="contentTitle" placeholder="Content Title"> <br>
        Content: <textarea rows='4' cols='50' type="text" name="content" placeholder="Content"></textarea><br>
        <input type="button" value='Add Component' onclick="addComponent()">
    </form>
</div>


<script type="text/javascript">

    //*********************************
    // INITIAL STATE
    //*********************************

    var thisCourse;
    $('#viewModCom').hide();
    $('#viewComponents').hide();
    $('#viewCourses').show();
    loadCourses();

    //load categories for course creation form
    $.ajax({
        url: 'http://localhost:8000/courses/categories',
        type: 'GET',
        dataType: 'json',
        success(result,status,xhr) {    
            $.each(result.all_categories, function(index, value) {
                $('select[name=category]').append("<option value='" + value.name + "'>" + value.name + "</option>");          
            });
        }
    });


    //*********************************
    // PAGE CONTROL LOGIC
    //*********************************

    $('#viewModCom').on('click','h3 a', function() {
        $('#viewModCom').hide();
        $('#viewCourses').show();
    });

    $("#viewCourses").on('click','a',function(){
        $('#viewCourses').hide();
        $('#viewModCom').show();
        thisCourse = $(this).attr('rel');
        loadModules();
    });


    //*********************************
    // VIEW COURSES
    //*********************************

    //load all courses created by this instructor
    function loadCourses() {
        $.ajax({
            url: 'http://localhost:8000/staff/' + getCookie('staffId') + '/courselist_instructor',
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {      
                $("#courseList").empty();
                console.log(JSON.stringify(result))        
                $.each(result.course_list, function(index, value) {
                    $("#courseList").append("<p><a href='#' rel='" + value.courseCode + "'>" + value.courseCode + ": " + value.title + "</a><br>Category: " + value.category + "<br>Description: " + value.description + '</p>');
                    if(!value.isPublished)
                        $("#courseList").append("<button rel='" + value.courseCode + "' type='button'>Publish</button>");             
                });
            }
        });
    }

    //add a course
    function addCourse() {
        var form = document.getElementById('addCourseForm');
        $.ajax({
            url: 'http://localhost:8000/courses/addCourse',
            type: 'POST',
            data: JSON.stringify({
                instructor: getCookie('staffId'),
                courseCode: form.courseCode.value,
                category: form.category.value,
                isPublished: false,
                title: form.title.value,
                description: form.description.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadCourses();
                }
            }
        });
    }

    //update course
    function updateCourse() {
        var form = document.getElementById('updateCourseForm');
        $.ajax({
            url: 'http://localhost:8000/courses/' + form.oldCourseCode.value + '/update_course_contents',
            type: 'POST',
            data: JSON.stringify({
                new_courseCode: form.courseCode.value,
                new_category: form.category.value,
                new_title: form.title.value,
                new_description: form.description.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadCourses();
                }
            }
        });
    }

    //publish a course
    $('#courseList').on('click', 'button', function() {
        cf = confirm("Please confirm that you want to publish this course");
        if (cf) {
            $.ajax({
                url: 'http://localhost:8000/courses/' + $(this).attr('rel') + '/publish',
                type: 'POST',
                dataType: 'json',
                beforeSend(xhr) {
                    xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                },
                success(result,status,xhr) {
                    loadCourses();
                }
            });
        }
    });

    //*********************************
    // VIEW COMPONENTS AND MODULES
    //*********************************

    //display modules and components
    function loadModules() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $("#sortable").empty();
                $.each(result.modules, function(index, value) {
                    $('#sortable').append("<li class='ui-state-default'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><a href='#' rel='" + value.id + "'><b>Module " + value.sequenceNumber + " : " + value.moduleTitle + "</b> - " + value.component_count + " components</a></li>");
                    $('#sortable').append("<div id='" + value.id + "'></div>");
                });
            }
        });
    }

    //view components of this module
    /*$('#sortable').on('click','a',function() {
        var thisModuleId = $(this).attr('rel');
        if($('#' + thisModuleId).is(':empty') ) {
            $.ajax({
                url: 'http://localhost:8000/courses/' + thisCourse,
                type: 'GET',
                dataType: 'json',
                success(result,status,xhr) {
                    $.each(result.modules, function(index, value) {
                        if (value.id == thisModuleId)
                        $.each(value.components, function(index, data) {
                            $('#' + thisModuleId).append("<p>Component " + data.order + " : " + data.contentTitle + "<br>" + data.content + "</p>");
                        });
                    });
                }
            });
        } else {
            $('#' + thisModuleId).empty();
        }
    });*/


    //add modules
    function addModule() {
        var form = document.getElementById('addModuleForm');
        $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse + "/addModule",
            type: 'POST',
            data: JSON.stringify({
                moduleTitle: form.moduleTitle.value,
                sequenceNumber: form.sequenceNumber.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadModules();
                }   
            }
        });
    }

    function addComponent() {
        var form = document.getElementById('addComponentForm');
        $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse + "/modules/" + form.moduleSeq.value + "/addComponent",
            type: 'POST',
            data: JSON.stringify({
                order: form.order.value,
                contentType: form.contentType.value,
                content: form.content.value,
                contentTitle: form.contentTitle.value
            }),
            dataType: 'json',
            beforeSend(xhr) {
                xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
            },
            success(result,status,xhr) {
                if (result.hasOwnProperty('failure'))
                    alert(result.message);
                else {
                    loadModules();
                }                
            }
        });
    }
</script>

{% endblock %}