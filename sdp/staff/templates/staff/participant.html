{% extends "staff/header.html" %}
{% block content %}
<div class="container-fluid">
    <div id="roleOptions" class="row">
        <div class="col-md-6 "><button id="viewCoursesBtn" class="btn btn-default btn-block btn-lg active" aria-pressed="true">View Available Courses</button></div>
        <div class="col-md-6 "><button id="viewEnrollmentBtn" class="btn btn-primary btn-block btn-lg active" aria-pressed="true">My Enrollment</button></div>
        <!--<div class="col-md-4"><button id="enrollmentHistBtn" class="btn btn-block btn-lg" style="border-color:#999999; border-width: 2px;">Enrollment History</button></div>-->
    </div>
    
    <div id="viewCourses" class="row">
        <h3>All Courses</h3>
        <div id="courseList">
            <form id='filterByForm' class="form-inline">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="theFilter">Filter by:</label>
                        <select class="form-control" id="theCategories" value='' name="category">
                            <option>All Categories</option>
                        </select>
                        <br>
                        <p>Click for details:</p>
                        <div id="courseFilteredList"></div>
                        <!--<input class="btn btn-primary btn-block" type='button' onclick='searchParticipants()' value='Search'>-->
                    </div>
                </div>
            </form>
        </div>
        <div id="courseDetails"></div>
    </div>
    <div id="viewEnrollment" class="row">
        <h3 style="text-align: center;">My Enrollments</h3>
        <div id="enrollmentList"></div>
        <div id="enrollmentDetails"></div>
        <div id="viewModules">
            <ul id="moduleList"></ul>
            <div id="proceedBtnDiv"></div>
            <div id="viewComponents">
                <ul id="componentList"></ul>
                    <!--<h4 style="text-align:center">Component Content</h4>-->
                    <div id="componentContent"></div>
            </div>
        </div>
    </div>
    <!--<div id="viewHistory" class="row">
        <h3>Past Enrollments</h3>
        <div id="pEnrollmentList"></div>
        <div id="pEnrollmentDetails"></div>
    </div>-->
</div>
<!--
<div style="text-align: center;"><button id="viewCoursesBtn">All Courses</button><button id="viewEnrollmentBtn">My Enrollment</button></div>-->


<!--<div id="viewCourses">
    <h3>All Courses</h3>
    <div id="courseList">
        Filter by: <select name='category'><option value='' selected>All Categories</option></select>
        <div id='courseFilteredList'></div>
    </div>
    <div id="courseDetails"></div>
</div>

<div id="viewEnrollment">
    <h3>My Enrollment</h3>
    <div id="enrollmentList"></div>
    <div id="enrollmentDetails"></div>
</div>-->

<script type="text/javascript">
    
    //*********************************
    // INITIAL STATE
    //*********************************

    var thisCourse;	//CS100 examples
    var thisCourse_id; //integer id in db
    var thisUsername;
    var thisModule;
    var progress;
    var numModules;
    $(document).ready(function() {
        $.ajax({
            url: 'http://localhost:8000/staff/'+getCookie('staffId')+'/getStaffUsername',
            type: 'GET',
            dataType: 'json',
            success(result, status, xhr) {
                thisUsername = result.username;
            }
        });
        loadEnrollment(); 
        $('#viewCourses').hide();
        $('#viewModules').hide();
        $('#proceedBtnDiv').hide();
        $('#viewComponents').hide();
        $('#viewEnrollment').show();
        $("#enrollmentDetails").hide();
        $("#enrollmentList").show();
    });


    //load categories for filtering
    $.ajax({
        url: 'http://localhost:8000/courses/categories',
        type: 'GET',
        dataType: 'json',
        success(result,status,xhr) {    
            $.each(result.all_categories, function(index, value) {
                $('select[name=category]').append("<option value='" + value.name + "'>" + value.name + "</option>");          
            });
        }
    });

    //*********************************
    // PAGE CONTROL LOGIC
    //*********************************

    $('#viewCoursesBtn').on('click',function(){
        $('#viewModules').hide();
        $('#proceedBtnDiv').hide();
        $("#viewCoursesBtn").attr('class', 'btn btn-primary btn-block btn-lg');
        $("#viewEnrollmentBtn").attr('class','btn btn-block btn-lg');
        $('#viewEnrollment').hide();
        $('#viewCourses').show();
        $('#courseDetails').hide();
        $('#courseList').show(); 
        loadCourses();
    });

    $('#viewEnrollmentBtn').on('click',function(){
        $('#viewModules').hide();
        $('#proceedBtnDiv').hide();
        $('#viewComponents').hide();
        $("#viewCoursesBtn").attr('class', 'btn btn-block btn-lg');
        $("#viewEnrollmentBtn").attr('class','btn btn-primary btn-block btn-lg');
        $('#viewCourses').hide();
        $('#viewEnrollment').show();
        $("#enrollmentDetails").hide();
        $("#enrollmentList").show();
        loadEnrollment();
    });

    /*$('#enrollmentHistBtn').on('click',function(){
        $('#viewCourses').hide();
        $('#viewEnrollment').hide();
        $("#enrollmentDetails").hide();
        $("#enrollmentList").hide();
        $("#viewHistory").show();
        //loadEnrollment();
    });*/

    $('#enrollmentList').on('click', 'a', function() {
        $('#viewModules').show();
        $("#enrollmentList").hide();
        $("#enrollmentDetails").show();
        thisCourse = $(this).attr('rel');
        progress = $(this).attr('ral');
        $.ajax({
            url: 'http://localhost:8000/courses/'+thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {    
                numModules = result.module_count;
            }
        });
        loadEnrollmentDetails();
        loadModules();
    });

    $('#courseList').on('click', 'a', function() {
        //$('#viewHistory').hide();
        $("#courseList").hide();
        $("#courseDetails").show();
        thisCourse = $(this).attr('rel');
        thisCourse_id = $(this).attr('ral');
        viewCourseDetails();
    });

    //reload courses when the category filter is changed
     $('#courseList').on('change', 'select', function() {
        loadCourses();
     });

    //adds event listener to module list
    $('#moduleList').on('click','li a',function() {
        //$('#viewModules').hide();
        //$('#enrollmentList').hide();
        $("#proceedBtnDiv").empty();
        thisModule = $(this).attr('rel');
        console.log(thisModule);
        console.log($('#' + thisModule).is(':empty'));
        loadComponents();
        if(progress == numModules) {
            $("#proceedBtnDiv").empty();
            $("componentList").show();
        }
        //$("#viewModules").show();
        $('#proceedBtnDiv').show();
        $('#viewComponents').show();
    });

    $('#proceedBtnDiv').on('click', 'button',function () {
        if (progress < numModules) {
            progress++;
            $('#viewComponents').hide();
            $('#componentList').hide();
            $('#componentContent').hide();
            $(this).hide();
            //loadModules();
            updateCourseProgress();
        }
        else {
            progress = 0;
        }
        //console.log("progress: " + progress);
        
        //$('')
    });

    //*********************************
    // VIEW ENROLLMENT
    //*********************************

    //load all course enrollments
    function loadEnrollment() {
    	var theCourseCode;
        $.ajax({
            url: 'http://localhost:8000/staff/' + getCookie('staffId') + '/enrolled',
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr){
                $("#enrollmentList").empty();
                console.log(JSON.stringify(result));
                $.each(result.course_list, function(index, value) {
                    $("#enrollmentList").append("<p><a href='#' rel='" + value.courseCode + "' ral='" + value.progress + "'>" + value.courseCode + ": " + value.title + "</a><br> Progress: " + value.progress + " modules completed</p>");
                    if(!value.isCompleted || value.isRetaking)
                        $("#enrollmentList").append("<button type='button' class='btn btn-danger'rel='" + value.courseCode + "' ral='" + value.progress + "'>Drop Course</button>");      
                });
            }
        });
    }

    //view details of an enrolled course, including its components and modules
    function loadModules() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                /*$("#enrollmentDetails").empty();
                $("#enrollmentDetails").append("<h3>Course Info</h3>");
                $("#enrollmentDetails").append("<p><b>" + result.courseCode + ": " + result.title + "</b><br>Category: " + result.category_name + "<br>Instructor: " + result.instructor_info.username + "<br>Description: " + result.description + "<br>Number of Modules: " + result.module_count + "</p>");
                $("#enrollmentDetails").append("<h3>Modules & Components</h3>");*/
                $("#moduleList").empty();
                var count = 0;
                $.each(result.modules, function(index, value) {
                    if (count <= progress) {
                        /*$('#enrollmentDetails').append("<p><a href='#' rel='" + value.id + "'><b>Module " + value.sequenceNumber + " : " + value.moduleTitle + "</b> - " + value.component_count + " components</a></p>");
                        $('#enrollmentDetails').append("<div id='" + value.id + "'></div>");*/
                        /*$('#moduleList').append("<li class='ui-state-default' id='"+value.id+"'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><a href='#' rel='" + value.sequenceNumber + "''><b>Module " + value.sequenceNumber + " : " + value.moduleTitle + "</b> - " + value.component_count + " components</a><div id='" + value.id + "'></div></li>");*/
                        $('#moduleList').append("<li id='"+value.id+"'><a href='#' rel='" + value.sequenceNumber + "''><b>Module " + value.sequenceNumber + " : " + value.moduleTitle + "</b> - " + value.component_count + " components</a><div id='" + value.id + "'></div></li>");
                        count++;
                    }
                });
            }
        });
    }

    function loadEnrollmentDetails() {
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $("#enrollmentDetails").empty();
                $("#enrollmentDetails").append("<h3>Course Info</h3>");
                $("#enrollmentDetails").append("<p><b>" + result.courseCode + ": " + result.title + "</b><br>Category: " + result.category_name + "<br>Instructor: " + result.instructor_info.username + "<br>Description: " + result.description + "<br>Number of Modules: " + result.module_count + "</p>");
            }
        });
    }



    function loadComponents() {
        var flagC; //if the course is completed
        var flagD; //if the course is retaken
        $.ajax({
            url: 'http://localhost:8000/staff/'+getCookie('staffId')+'/enrolled',
            async: false,
            dataType: 'json',
            success(result, status, xhr) {
                //console.log("This is the list");
                //console.log(result.course_list);
                $.each(result.course_list, function(index, value) {
                    if(thisCourse == value.courseCode) {
                        flagC = value.isCompleted;
                        flagD = value.isRetaking;
                        console.log(flagC);
                        console.log(flagD);
                    }
                });
            }
        });
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $('#componentList').empty();
                $('#componentContent').empty();
                //console.log("This is the course progress");
                //console.log(result.isCompleted);
                //console.log(result.isRetaking);
                $.each(result.modules, function(index, value) {
                    //console.log("The value");
                    /*console.log($.trim(value));*/
                    //console.log(value)
                    //console.log(value.component_count);
                    if(value.component_count == 0 && value.sequenceNumber == thisModule) {
                        if(flagC ==flagD) {
                            $('#proceedBtnDiv').empty();
                            $('#proceedBtnDiv').show();
                            $('#proceedBtnDiv').append("<button rel='" + value.id + "' type='button' class='btn btn-primary'>Next Module</button>");
                        }

                    }
                    else {
                        console.log("The sequence");

                        console.log(value.sequenceNumber);
                        console.log("This mod");
                        console.log(thisModule);
                        if (value.sequenceNumber == thisModule) {
                            if(flagC == flagD) {
                                $('#proceedBtnDiv').empty();
                                $('#proceedBtnDiv').show();
                                $('#proceedBtnDiv').append("<button rel='" + value.id + "' type='button' class='btn btn-primary'>Next Module</button>");
                            }
                            $.each(value.components, function(index, data) {
                                /*console.log("The data");
                                console.log($.trim(data));
                                console.log(data);*/

                                //$('#componentList').append("<li class='ui-state-default' id='"+data.contentType+"|"+data.id+"'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><a href='#' rel='" + data.id + "' ral='" + data.contentType + "'><b>Component " + data.order + " : " + data.contentTitle + "</b></a><div id='" + data.id + "'></div></li>");
                                $('#componentList').append("<li id='"+data.contentType+"|"+data.id+"'><a href='#' rel='" + data.id + "' ral='" + data.contentType + "'><b>Component " + data.order + " : " + data.contentTitle + "</b></a><div id='" + data.id + "'></div></li>");
                            });
                        }
                    }
                });
            }
        });
    }
    //display component content
    $('#componentList').on('click','li a', function() {
        /*var flagC; //if the course is completed
        var flagD; //if the course is retaken
        $.ajax({
            url: 'http://localhost:8000/staff/'+getCookie('staffId')+'/enrolled',
            async: false,
            dataType: 'json',
            success(result, status, xhr) {
                //console.log("This is the list");
                //console.log(result.course_list);
                $.each(result.course_list, function(index, value) {
                    if(thisCourse == value.courseCode) {
                        flagC = value.isCompleted;
                        flagD = value.isRetaking;
                        //console.log(flagC);
                        //console.log(flagD);
                    }
                });
            }
        });*/
        var thisComponent = $(this).attr('rel');
        var contentType = $(this).attr('ral');
        //console.log(thisComponent);
        //console.log(contentType);
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $('#componentContent').empty();
                $.each(result.modules, function(index, value) {

                    if (value.sequenceNumber == thisModule) {
                        $.each(value.components, function(index, data) {
                            //$("#componentContent h4").empty();
                            console.log("this is the data order");
                            console.log(data.order);
                            if(data.id == thisComponent) {
                                $("#componentContent").append("<h4 style='text-align:center;'>"+data.contentTitle+"</h4>");
                                if (data.id == thisComponent) {
                                    if (contentType == 'text')
                                        $('#componentContent').append("<p>" + data.content + "</p>");
                                    else if (contentType == 'image') {
                                        //console.log("Image content detected.");
                                        //console.log(data.content);

                                        $('#componentContent').append("<img width='60%' src='http://127.0.0.1:8000/uploads/" + data.content + "' class='img-responsive' style='text-align:center'>");
                                    }
                                    else if (contentType == 'video')
                                        $('#componentContent').append("<video width='60%' controls><source src='http://127.0.0.1:8000/uploads/" + data.content + "' type='video/mp4'>Your browser does not support HTML5 video.</video>");
                                    else if (contentType == 'file')
                                        $('#componentContent').append("<a href='http://127.0.0.1:8000/uploads/" + data.content + "' download>Download File</a>");
                                    
                                }
                            }
                        });
                        /*if(((flagC == true && flagD == true) || (flagC == false && flagD == false)) && ) {
                            console.log("this one");
                            $('#proceedBtnDiv').empty();
                            $('#proceedBtnDiv').show();
                            $('#proceedBtnDiv').append("<button rel='" + value.id + "' type='button' class='btn btn-primary'>Next Module</button>"); 
                        }*/
                    }
                    //$('#moduleList').append("<button rel='" + value.id + "' ral='" + contentType + "' type='button' class='btn btn-primary'>Next Module</button>");
                });
            }
        });
    });    
    /*
    //view components of this module
    $('#enrollmentDetails').on('click','a',function() {
        var thisModuleId = $(this).attr('rel');
        if($('#' + thisModuleId).is(':empty') ) {
            $.ajax({
                url: 'http://localhost:8000/courses/' + thisCourse,
                type: 'GET',
                dataType: 'json',
                success(result,status,xhr) {
                    $.each(result.modules, function(index, value) {
                        if (value.id == thisModuleId)
                        $.each(value.components, function(index, data) {
                            $('#' + thisModuleId).append("<p>Component " + data.order + " : " + data.contentTitle + "<br>" + data.content + "</p>");
                        });
                    });
                    $('#' + thisModuleId).append("<button type='button' class='btn btn-primary'>Next Modules</button>");
                }
            });
        } else {
            $('#' + thisModuleId).empty();
        }
    });*/
    function updateCourseProgress(){
        var course_id = $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                console.log("This is the course id:" + result.id);

                $.ajax({
                    url: "http://localhost:8000/courses/update_course_progress",
                    type: 'POST',
                    data: JSON.stringify({
                        course_id : result.id,
                        staff_id : getCookie('staffId'),
                        new_status : progress
                    }),
                    dataType: 'json',
                    beforeSend(xhr){
                        xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                    },
                    success(data,status,xhr) {
                        if (data.hasOwnProperty('failure'))
                            alert(result.message);
                        else {
                            //marked
                            loadModules();
                        }
                    }
                });
            }
        });
    }
    //mark this module as completed and reload all modules
    /*$('#enrollmentDetails').on('click','button', function() {
        //progress++;
        var course_id = $.ajax({
            url: "http://localhost:8000/courses/" + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
            	console.log("This is the course id:" + result.id);

                $.ajax({
                    url: "http://localhost:8000/courses/update_course_progress",
                    type: 'POST',
                    data: JSON.stringify({
                        course_id : result.id,
                        staff_id : getCookie('staffId'),
                        new_status : progress
                    }),
                    dataType: 'json',
                    beforeSend(xhr){
                        xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                    },
                    success(data,status,xhr) {
                        if (data.hasOwnProperty('failure'))
                            alert(result.message);
                        else {
                            //marked
                            loadModules();
                        }
                    }
                });
            }
        });
    });*/

    //drop a course    
    $('#enrollmentList').on('click', 'button', function () {
        var cf = confirm('Please confirm that you would like to drop this course.');
        if (cf) {
            var progress = $(this).attr('ral');
            var course_id = $.ajax({
                url: "http://localhost:8000/courses/" + $(this).attr('rel'),
                type: 'GET',
                dataType: 'json',
                success(result,status,xhr) {
                    $.ajax({
                        url: "http://localhost:8000/courses/drop_course",
                        type: 'POST',
                        data: JSON.stringify({
                            course_id : result.id,
                            staff_id : getCookie('staffId'),
                            new_status : progress
                        }),
                        dataType: 'json',
                        beforeSend(xhr){
                            xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
                        },
                        success(data,status,xhr) {
                            if (data.hasOwnProperty('failure'))
                                alert(result.message);
                            else
                                loadEnrollment();
                        }
                    });
                }
            });
        }
    });

    //*********************************
    // VIEW ALL COURSES
    //*********************************

    //load all courses
    function loadCourses() {
        var completedCoursesIDs = [];
        var createdCourses = [];
        $.ajax({
            url: 'http://localhost:8000/staff/'+thisUsername+'/courseCompleted',
            async: false,
            type: 'GET',
            dataType: 'json',
            success(result, status, xhr) {
                $.each(result.completed_enrolls, function(index,value){
                    completedCoursesIDs[index] = value.id;
                });
            }
        });
        $.ajax({
            url: 'http://localhost:8000/staff/'+getCookie('staffId')+'/courselist_instructor',
            async: false,
            type: 'GET',
            dataType: 'json',
            success(result, status, xhr) {
                //console.log('happening');
                $.each(result.course_list, function(index,value){
                    console.log(value.courseCode);
                    createdCourses[index] = value.courseCode;
                });
            }
        });
        $.ajax({
            url: 'http://localhost:8000/courses/',
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
                $('#courseFilteredList').empty();               
                $.each(result.all_courses, function(index, value) {
                    if(value.isPublished) {
                        if($('select[name=category]').val() === 'All Categories') {
                        	//console.log(completedCoursesIDs);
                            //console.log(value.id);
                            //console.log($.inArray(value.id, completedCoursesIDs));
                            if($.inArray(value.id, completedCoursesIDs) != -1) //display completed tag if completed
                                $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag tag-success myTag-success\" style='margin-left:3px'>Completed!</span><br> Category: " + value.category_name + "</p>");
                            else{ //display enrollable tag if enrollable
                                console.log($.inArray(value.courseCode, createdCourses));
                                if($.inArray(value.courseCode, createdCourses) != -1)
                                    $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag myTag-owned\">Owned</span><br> Category: " + value.category_name + "</p>");
                                else
                                    $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag myTag-enrollable\" style='margin-left:3px'>Enrollable!</span><br> Category: " + value.category_name + "</p>");      
                            }

                        }
                        else {
                            console.log('b');
                            if ($('select[name=category]').val() == '')
                                $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><br>"); // <-- This case never occurs?
                            else if ($('select[name=category]').val() == value.category_name)  {
                                if($.inArray(value.id, completedCoursesIDs) != -1) //display completed tag if completed
                                    $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag tag-success myTag-success\" style='margin-left:3px'>Completed!</span><br> Category: " + value.category_name + "</p>");
                                else{ //display enrollable tag if enrollable
                                    console.log($.inArray(value.courseCode, createdCourses));
                                    if($.inArray(value.courseCode, createdCourses) != -1)
                                        $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag myTag-owned\">Owned</span><br> Category: " + value.category_name + "</p>");
                                    else
                                        $("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><span class=\"tag myTag-enrollable\" style='margin-left:3px'>Enrollable!</span><br> Category: " + value.category_name + "</p>");      
                                }
                                //$("#courseFilteredList").append("<p><a href='#' rel='" + value.courseCode + "' ral='"+ value.id+"'>" + value.courseCode + ": " + value.title + "</a><br>");
                            }
                        }
                    }
                                   
                });
            }
        });
    }

    //view course details
    function viewCourseDetails() {
    	var arrayCourses = [];
    	var flag;
        var flagB; // for isRetaking
    	var i;
        var createdCourses = [];
        $.ajax({
            url: 'http://localhost:8000/staff/'+getCookie('staffId')+'/courselist_instructor',
            async: false,
            type: 'GET',
            dataType: 'json',
            success(result, status, xhr) {
                //console.log('happening');
                $.each(result.course_list, function(index,value){
                    console.log(value.courseCode);
                    createdCourses[index] = value.courseCode;
                });
            }
        });
    	$.ajax({
            url: 'http://localhost:8000/staff/' + getCookie('staffId') + '/enrolled',
            async: false,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr){
                $("#enrollmentList").empty();
                console.log(JSON.stringify(result));
                $.each(result.course_list, function(index, value) {
                    arrayCourses[index] = value;
                });
                for (i = 0; i < arrayCourses.length; i++) {
    		    	if(arrayCourses[i].courseCode === thisCourse) {
        				(arrayCourses[i].isCompleted ? flag = true : flag = false);
        			}
                    if(arrayCourses[i].courseCode === thisCourse) {
                        (arrayCourses[i].isRetaking? flagB = true : flagB = false);
                    }
        		}
            }
        });
        //console.log(arrayCourses[0]);
        $.ajax({
            url: 'http://localhost:8000/courses/' + thisCourse,
            type: 'GET',
            dataType: 'json',
            success(result,status,xhr) {
            	console.log(result);
                $("#courseDetails").empty();
                $("#courseDetails").append("<p><b>" + result.courseCode + ": " + result.title + "</b><br>Category: " + result.category_name + "<br>Instructor: " + result.instructor_info.username + "<br>Description: " + result.description + "<br>Number of Modules: " + result.module_count + "</p>");
                if(!flag){
                    console.log(result.courseCode);
                    if($.inArray(result.courseCode, createdCourses) != -1)
                	   $("#courseDetails").append("<button name='disabledBtn' type='button' class='btn btn-primary disabled' rel='" + result.courseCode + "'>Enroll</button>");
                    else
                        $("#courseDetails").append("<button name='enrollBtn' type='button' class='btn btn-primary' rel='" + result.courseCode + "'>Enroll</button>");
                }
                else {
                    if(!flagB)
                	   $("#courseDetails").append("<button name='retakeBtn' class='btn btn-primary' style=\"background: #2CD453; border-color: #2CD453\" rel='" + result.courseCode + "'>Retake</button>");
                    else
                        $("#courseDetails").append("<button name='disabledBtn' class='btn btn-primary disabled' style=\"background: #2CD453; border-color: #2CD453\" rel='" + result.courseCode + "'>Retake</button>");

                }
            }
        });

    }

    //enroll or retake a course
    $('#courseDetails').on('click', 'button', function () {

    	var whichButton = $('#courseDetails button').attr("name");
    	//console.log(thisCourse_id);
    	//In the case of enroll
    	if(whichButton === 'enrollBtn') {
        	var cf = confirm('Please confirm that you would like to enroll in this course.');
        	if (cf) {
	            $.ajax({
	                url: "http://localhost:8000/courses/" + $(this).attr('rel') + "/enroll",
	                type: 'POST',
	                data: JSON.stringify({staff_id : getCookie('staffId')}),
	                dataType: 'json',
	                beforeSend(xhr){
	                    xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
	                },
	                success(result,status,xhr) {
	                    if (result.hasOwnProperty('failure'))
	                        alert(result.message);
	                    else
	                        window.location.reload();
	                }
	            });
        	}
    	}//Case of retake
        else if (whichButton === 'retakeBtn') {
        	var cf = confirm('Please confirm that you would like to retake this course.');
        	if (cf) {
	            $.ajax({
	                url: "http://localhost:8000/courses/retake_course",
	                type: 'POST',
	                data: JSON.stringify({
	                	course_id : thisCourse_id, 
	                	staff_id : getCookie('staffId')}),
	                dataType: 'json',
	                beforeSend(xhr){
	                    xhr.setRequestHeader("Content-Type","application/x-www-urlencoded");
	                },
	                success(result,status,xhr) {
	                    if (result.hasOwnProperty('failure'))
	                        alert(result.message);
	                    else
	                        window.location.reload();
	                }
	            });
        	}
        }
        
    });
</script>

{% endblock %}